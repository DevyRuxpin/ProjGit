{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>Price Alerts</h2>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAlertModal">
            Create Alert
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cryptocurrency</th>
                                <th>Condition</th>
                                <th>Price Threshold</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in alerts %}
                            <tr>
                                <td>{{ alert.cryptocurrency }}</td>
                                <td>{{ alert.condition }}</td>
                                <td>${{ "%.2f"|format(alert.price_threshold) }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if alert.is_active else 'secondary' }}">
                                        {{ 'Active' if alert.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>{{ alert.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-{{ 'warning' if alert.is_active else 'success' }}"
                                            onclick="toggleAlert({{ alert.id }})">
                                        {{ 'Deactivate' if alert.is_active else 'Activate' }}
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAlert({{ alert.id }})">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal fade" id="createAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAlertForm">
                    <div class="mb-3">
                        <label for="cryptocurrency" class="form-label">Cryptocurrency</label>
                        <input type="text" class="form-control" id="cryptocurrency" required>
                    </div>
                    <div class="mb-3">
                        <label for="condition" class="form-label">Condition</label>
                        <select class="form-control" id="condition" required>
                            <option value="above">Above</option>
                            <option value="below">Below</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="priceThreshold" class="form-label">Price Threshold (USD)</label>
                        <input type="number" class="form-control" id="priceThreshold" step="any" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createAlertBtn">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('createAlertBtn').addEventListener('click', async function() {
    const cryptocurrency = document.getElementById('cryptocurrency').value;
    const condition = document.getElementById('condition').value;
    const priceThreshold = document.getElementById('priceThreshold').value;

    try {
        const response = await fetch('/alerts/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cryptocurrency: cryptocurrency,
                condition: condition,
                price_threshold: priceThreshold
            })
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Error creating alert');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating alert');
    }
});

async function toggleAlert(alertId) {
    try {
        const response = await fetch(`/alerts/${alertId}/toggle`, {
            method: 'POST'
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Error toggling alert');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error toggling alert');
    }
}

async function deleteAlert(alertId) {
    if (confirm('Are you sure you want to delete this alert?')) {
        try {
            const response = await fetch(`/alerts/${alertId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting alert');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting alert');
        }
    }
}
</script>
{% endblock %}
